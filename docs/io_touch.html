<html>
<head>
    <title>Fangzheng Liu (MIT)</title>
    <link rel="stylesheet" href="./stylesheets/style.css">
    <script src="./stylesheets/code.module.css"></script>
    <meta name="viewport" content="width=1035px, initial-scale=1.0">
</head>
<body>

<div id="mySidenav" class="sidenav">
    <p><span class = "weeknum"><a href=index.html>Home</a> </span></p>
    <p><span class = "weeknum"><a href=projects.html>Research</a> </span></p>
    <p><span class = "weeknum"><a href=publications.html>Publications</a> </span></p>
    <p><span class = "weeknum"><a href=teachings.html>Teachings</a> </span></p>
    <!-- <p><span class = "weeknum"><a href=readings.html>Readings & Links</a> </span></p> -->
    <p><span class = "weeknum"><a href=cv.html>CV</a> </span></p>
</div>

<div id="myMainnav" class="mainnav">
    <h2>Any anlog pin is a capacitive sensor</h2>
    <p>
        <center>
            <b><i>Without any external components or capacitive sensor periperal, any analog pin can serve as a capacitive sensor and you can use it for touch pad or so. :)</i></b>
        </center>
    </p>

    <p>
        <center>
            <img src="./images/io_touch.jpg" class="center" width = "60%">
            <figcaption><i>RP2040 XIAO module with three touch pads connected with the analog pins and control the RGB LED.</i></figcaption>
        </center>
    </p>

    <p>
        The touch pad that conencts with an analog pin forms a capacitor, and the anlog pin outputs a very short pulse to charge the capacitor. Then the pin turns to analog input, which has big input resistance, and the capacitor discharges slowly through this big resistance. When your finger touches the pads, the capacitance will change which cause a change in the discharging process (discharge slower).
    </p>

    <p>
        <center>
            <img src="./images/discharge_change_process.gif" class="center" width = "60%">
            <figcaption><b><i>Discharging process changes when finger touches.</i></b></figcaption>
        </center>
    </p>

    <p>
        By taking a measurement at a fixed time point after the pulse, we can detect the change in dicharge and ditect touch.
    </p>

    <p>Here is the Arduino code for calibration and detection:</p>

    <code class = "codebox">
        <pre>
            #include "Adafruit_NeoPixel.h"

            int Power = 11;
            int PIN  = 12;
            #define NUMPIXELS 1

            #define CALI_CNT  30
            #define LED_PIN   25
            #define THRESHOLD 100

            Adafruit_NeoPixel pixels(NUMPIXELS, PIN, NEO_GRB + NEO_KHZ800);

            enum RGB_color {
              CLEAR, R, G, B
            };

            RGB_color flash_r = CLEAR;
            RGB_color flash_g = CLEAR;
            RGB_color flash_b = CLEAR;

            int cali_1 = 0;
            int cali_2 = 0;
            int cali_3 = 0;

            int calibration(int pin) {
              int sum = 0;

              for (int i = 0; i < CALI_CNT; i++) {
                pinMode(pin, OUTPUT);
                digitalWrite(pin, HIGH); // turn the LED on (HIGH is the voltage level)
                delayMicroseconds(10);               // wait for a second
                pinMode(pin, INPUT);
                delayMicroseconds(100);
                sum += analogRead(pin);
                delay(50);             // wait for a second
              }
              return (sum/CALI_CNT);
            }

            void flash_RGB(RGB_color color) {
              switch (color) {
                case R:
                  pixels.setPixelColor(0, pixels.Color(220, 0, 0));
                  pixels.show();
                  break;

                case G:
                  pixels.setPixelColor(0, pixels.Color(0, 220, 0));
                  pixels.show();
                  break;

                case B:
                  pixels.setPixelColor(0, pixels.Color(0, 0, 220));
                  pixels.show();
                  break;

                default:
                  pixels.clear();
                  pixels.show();
                  break;
              }
            }

            RGB_color sense_touch(int pin, int cali, RGB_color color) {
              pinMode(pin, OUTPUT);
              digitalWrite(pin, HIGH);
              delayMicroseconds(10);
              pinMode(pin, INPUT);
              delayMicroseconds(100);
              if (abs(analogRead(pin) - cali) > THRESHOLD) {
                return color;
              }
              else {
                return CLEAR;
              }
              delay(50);
            }

            void setup() {
              pixels.begin();
              pinMode(Power,OUTPUT);
              digitalWrite(Power, HIGH);

              pinMode(LED_PIN, OUTPUT);
              digitalWrite(LED_PIN, LOW);

              cali_1 = calibration(D0);
              cali_2 = calibration(D1);
              cali_3 = calibration(D2);

              digitalWrite(LED_PIN, HIGH);
            }

            void loop() {
              flash_r = CLEAR;
              flash_g = CLEAR;
              flash_b = CLEAR;

              RGB_color c1 = R;
              RGB_color c2 = G;
              RGB_color c3 = B;

              flash_r = sense_touch(D0, cali_1, c1); flash_RGB(flash_r);
              flash_g = sense_touch(D1, cali_2, c2); flash_RGB(flash_g);
              flash_b = sense_touch(D2, cali_3, c3); flash_RGB(flash_b);
            }
        </pre>
    </code>


    <p>
        <center>
            <iframe src="./images/io_touch.mp4"
            width= "60%" height="400" frameborder="0" allow="autoplay;
            fullscreen; picture-in-picture" allowfullscreen></iframe>
        </center>
    </p>

    <p>
        <i> With this approach, theoretically, any analog pin could serve as a capacitive sensor. Actually, using a digital pin may work, too. As the discharging process get longer, if we start a timer right after the pulse output and record the time length till the digital input gets to low, we can also realize a capacitive sensing. I will leave this for future work (the program might need soem filtering to lower the impact from the 60Hz noise). </i>
    </p>

</div>
